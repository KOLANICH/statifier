# Copyright (C) 2004 Valery Reznic
# This file is part of the Elf Statifier project
# 
# This project is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License.
# See LICENSE file in the doc directory.

TOP_DIR = ..
include $(TOP_DIR)/config

PACKAGE := statifier

SOURCES =                  \
   Makefile                \
   $(PACKAGE).files.common \
   $(PACKAGE).files.elf.in \
   $(PACKAGE).spec.in      \

EXTRA_DIST = $(PACKAGE).spec

all: 

define SpecFile
   {                                                                    \
      echo "#"                                                       && \
      echo "# Don't change this file. It was autogenerated by make"  && \
      echo "#"                                                       && \
      echo "%define my_version $(VERSION)"                           && \
      echo "%define my_release $(RELEASE)"                           && \
      echo                                                           && \
      cat  $(PACKAGE).spec.in                                        && \
      echo && echo %files     && sed 's/^#.*$$//' < $(PACKAGE).files && \
      echo && echo %changelog && cat $(TOP_DIR)/ChangeLog            && \
      :                                                              ;  \
   }
endef

$(PACKAGE).spec: $(PACKAGE).spec.in $(PACKAGE).files $(TOP_DIR)/VERSION $(TOP_DIR)/RELEASE $(TOP_DIR)/ChangeLog
	$(RM) $@
	$(SpecFile) > $@ || { $(RM) $@; exit 1; }

define Files
   {                                                                   \
      echo "#"                                                      && \
      echo "# Don't change this file. It was autogenerated by make" && \
      echo "#"                                                      && \
      cat $@.common                                                 && \
      sed -e "s/@ELF_CLASS@/32/g" < $@.elf.in                       && \
      sed -e "s/@ELF_CLASS@/64/g" < $@.elf.in                       && \
      :                                                             ;  \
   }
endef


$(PACKAGE).files: $(PACKAGE).files.common $(PACKAGE).files.elf.in
	$(RM) $@
	$(Files) > $@ || { $(RM) $@; exit 1; }

clean-local:
	$(RM) $(EXTRA_DIST) $(PACKAGE).files

include $(TOP_DIR)/Makefile.common
